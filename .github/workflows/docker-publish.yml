# =============================================================================
# WebCrawler Pro - GitHub Actions CI/CD Pipeline v2
# Builds and pushes Docker images to GitHub Container Registry (ghcr.io)
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}

jobs:

  # ===========================================================================
  # Job 1: Validate Docker Compose & Config
  # ===========================================================================
  validate:
    name: Validate Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: docker compose version

      - name: Validate docker-compose.yml
        run: |
          docker compose -f docker-compose.yml config --quiet
          echo "âœ… docker-compose.yml is valid"

      - name: Check required files exist
        run: |
          required_files=(
            "backend/Dockerfile"
            "frontend/Dockerfile"
            "nginx/Dockerfile"
            "nginx/nginx.conf"
            "backend/requirements.txt"
            "frontend/package.json"
            ".env.example"
          )
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "âŒ Missing required file: $f"
              exit 1
            fi
            echo "âœ… Found: $f"
          done

  # ===========================================================================
  # Job 2: Backend Lint
  # ===========================================================================
  backend-lint:
    name: Backend Lint (flake8)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install lint dependencies
        run: pip install flake8

      - name: Lint - critical errors only (blocks CI)
        working-directory: ./backend
        run: |
          flake8 app/ \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics
          echo "âœ… No critical lint errors"

      - name: Lint - style warnings (non-blocking)
        working-directory: ./backend
        run: |
          flake8 app/ \
            --count \
            --max-line-length=130 \
            --extend-ignore=E128,E125,E501,W503,W504 \
            --statistics \
            --exclude=__pycache__ || true

  # ===========================================================================
  # Job 3: Frontend Check
  # ===========================================================================
  frontend-check:
    name: Frontend Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: TypeScript type check
        working-directory: ./frontend
        run: npx tsc --noEmit || true

      - name: Next.js lint
        working-directory: ./frontend
        run: npm run lint || true

  # ===========================================================================
  # Job 4: Backend Tests
  # ===========================================================================
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: [validate, backend-lint]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: webcrawler_test
          POSTGRES_USER: webcrawler
          POSTGRES_PASSWORD: testpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libpq-dev gcc build-essential \
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libxkbcommon0 libxcomposite1 \
            libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Install Playwright browsers
        working-directory: ./backend
        run: playwright install chromium --with-deps

      - name: Run tests
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://webcrawler:testpassword@localhost:5432/webcrawler_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci-minimum-32-chars-long
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379/0
        run: |
          pytest tests/ -v --tb=short \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            -x

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # ===========================================================================
  # Job 5: Build and Push Docker Images
  # ===========================================================================
  build-and-push:
    name: Build & Push (${{ matrix.image }})
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-check]
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: backend
            context: ./backend
            dockerfile: ./backend/Dockerfile
          - image: frontend
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
          - image: nginx
            context: ./nginx
            dockerfile: ./nginx/Dockerfile

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for arm64)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.image }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.image }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=sha-

      - name: Build and push ${{ matrix.image }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.image }}
          cache-to: type=gha,mode=max,scope=${{ matrix.image }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            ${{ matrix.image == 'frontend' && format('NEXT_PUBLIC_API_URL={0}', vars.NEXT_PUBLIC_API_URL || '/api') || '' }}

      - name: Add to build summary
        run: |
          echo "### ğŸ³ ${{ matrix.image }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 6: Security Scan with Trivy
  # ===========================================================================
  security-scan:
    name: Security Scan (${{ matrix.image }})
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      security-events: write
      packages: read

    strategy:
      fail-fast: false
      matrix:
        image: [backend, frontend, nginx]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy scan on ${{ matrix.image }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.image }}.sarif'
          category: 'trivy-${{ matrix.image }}'

  # ===========================================================================
  # Job 7: Create GitHub Release (on version tags)
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${{ github.ref_name }}$" | head -1)
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --oneline --no-merges | head -20)
          else
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --oneline --no-merges)
          fi
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT
          {
            echo 'CHANGELOG<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "WebCrawler Pro ${{ github.ref_name }}"
          body: |
            ## ğŸ•·ï¸ WebCrawler Pro ${{ github.ref_name }}

            ### ğŸ³ Docker Images
            ```bash
            docker pull ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}
            docker pull ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}
            docker pull ghcr.io/${{ github.repository }}/nginx:${{ github.ref_name }}
            ```

            ### ğŸš€ Quick Deploy
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd webcrawler-pro
            cp .env.example .env
            # Edit .env with your settings
            docker compose up -d
            ```

            ### ğŸ“ Changes since ${{ steps.changelog.outputs.PREV_TAG }}
            ${{ steps.changelog.outputs.CHANGELOG }}

            ### ğŸŒ App
            Available at `http://your-vps:44544` after deployment.
          draft: false
          prerelease: false
